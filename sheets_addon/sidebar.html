<html>
    <head>
        <title>Gramble by Examble</title>
        <?!= include('grambleWrapped'); ?>
        <?!= include('style'); ?>
    </head>
    <body>
        <script>
            function letterFromNumber(n) { // number -> string
                var letter = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.charAt(n % 26)
                var concat = Math.round(n / 26);
                return concat > 0 ? letterFromNumber(concat-1) + letter : letter;
            };

            function getA1Notation(sheet, row, col) {
                if (sheet == "") {
                    return `${letterFromNumber(col)}${(row+1)}`;
                }
                return `${sheet}!${letterFromNumber(col)}${(row+1)}`;
            }

            var devEnv = undefined;  // SidebarDevEnvironment
            var project = undefined; // Project
            var CURRENT_TAPES = [];
            var CURRENT_INPUTS = {};

            class SidebarDevEnvironment {

                constructor(cellsBySheet) {
                    this.cellsBySheet = cellsBySheet; // {[key: string}: string[][]
                    this.errorMsgs = []; // list of [sheet, row, col, shortMsg, msg, level]
                }

                hasSource(sheetName) { 
                    return (sheetName in this.cellsBySheet);
                }

                loadSource(sheetName) {
                    if (!(this.hasSource(sheetName))) {
                        return [];
                    }
                    return this.cellsBySheet[sheetName];
                }

                markError(sheet, row, col, shortMsg, msg, level = "error") { 
                    this.errorMsgs.push([sheet, row, col, shortMsg, msg, level]);
                }

                markHeader(sheet, row, col, color) { }
                markTier(sheet, row, col, color) { }
                markCommand(sheet, row, col) { }
                markSymbol(sheet, row, col) { }
                highlight() { }

            }

            function scriptRunPromise() {
                const gs = {};
                const keys = Object.keys(google.script.run);
                for (let i=0; i < keys.length; i++) {
                    gs[keys[i]] = (function(key) {
                    return function(...args) {
                        return new Promise(function(resolve, reject) {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)[key]
                            .apply(google.script.run, args);
                        });
                    };
                    })(keys[i]);
                }
                return gs;
            }

            function removeElementsByClass(className) {
                var inputsToRemove = document.getElementsByClassName(className);
                while(inputsToRemove.length > 0){
                    inputsToRemove[0].parentNode.removeChild(inputsToRemove[0]);
                }

            }

            var reloadGrammarLock = false;
            async function reloadGrammar() {
                
                if (reloadGrammarLock) {
                    return;
                }

                reloadGrammarLock = true;

                // hide or remove everything in the control panel except "Loading..."
                const controlTable = document.getElementById("controlTable");
                controlTable.style.visibility = "collapse";
                const sampleTable = document.getElementById("sampleTable");
                sampleTable.style.visibility = "collapse";
                removeElementsByClass("tapeInputTr");
                removeElementsByClass("errorButton");
                const resultsTable  = document.getElementById("resultsTable"); 
                resultsTable.innerHTML = "";
                resultsTable.style.visibility = "collapse";
                const loadingP = document.getElementById("loadingP");
                loadingP.style.display = "block";

                // ask for the latest data from GSuite
                const responseFromGSuite = await scriptRunPromise().getAllCells();
                
                if (!responseFromGSuite["success"]) {
                    throw new Error("Failed to communicate with Google Sheets backend: " +
                        `${responseFromGSuite["message"]}`);
                }

                const currentSheetName = responseFromGSuite["payload"]["startSheet"];
                const cellsBySheet = responseFromGSuite["payload"]["sheets"];
                
                devEnv = new SidebarDevEnvironment(cellsBySheet);
                project = new gramble.Project(devEnv);
                project.addSheet(currentSheetName);
                
                createErrorButtons(devEnv.errorMsgs, currentSheetName);
                reloadSymbols(currentSheetName);
                reloadInputs();

                loadingP.style.display = "none";
                controlTable.style.visibility = "visible";
                sampleTable.style.visibility = "visible";
                resultsTable.style.visibility = "visible";
                reloadGrammarLock = false;
            }

            function createErrorButtons(errorMsgs, currentSheetName) {

                if (devEnv.errorMsgs.length == 0) {
                    return;
                }

                
                const errorArea = document.getElementById("errorArea");
                
                for (const [sheet, row, col, shortMsg, msg, lvl] of errorMsgs) {

                    if (lvl != "error") {
                        return;
                    }

                    const button = document.createElement('button');
                    button.classList.add('errorButton');
                    var cellName = getA1Notation("", row, col);
                    if (sheet != currentSheetName) {
                        cellName = `${sheet}!${cellName}`; 
                    }
                    button.innerHTML = `${cellName}: ${shortMsg}`;
                    button.title = msg;
                    button.onclick = async function() {
                        await scriptRunPromise().scrollToCell(sheet, row, col);
                        return false;
                    };
                    errorArea.appendChild(button);
                }
            }

            
            function reloadSymbols(currentSheetName) {

                if (project == undefined) {
                    throw new Error("Trying to reload symbols without a project");
                }

                const select = document.getElementById("selectSymbol"); 
                select.innerHTML = "";
                
                var options = project.allSymbols();
                for (const option of options) {
                    const el = document.createElement('option');

                    var optionText = option;
                    const pieces = option.split(".");
                    if (pieces[0] == currentSheetName) {
                        optionText = pieces.slice(1).join(".");
                    }
                    el.textContent = optionText;
                    el.value = option;
                    if (optionText.toLowerCase() == 'main') {
                        el.selected = true;
                    }
                    select.appendChild(el);
                } 
            }

            function reloadInputs() {

                const select = document.getElementById("selectSymbol"); 
                const currentSymbol = select.value;
                
                CURRENT_TAPES = project.getTapeNames(currentSymbol);

                const controlTable = document.getElementById("controlTable");
                for (const [tapeName, color] of CURRENT_TAPES) {
                    const tr = document.createElement("tr");
                    tr.classList.add("tapeInputTr");
                    tr.style.backgroundColor = color;
                    const labelTd = document.createElement("td");
                    labelTd.classList.add("labelTd");
                    const label = document.createElement("label");
                    label.htmlFor = `input_${tapeName}`;
                    label.innerHTML = tapeName;
                    labelTd.appendChild(label);
                    tr.appendChild(labelTd);
                    const inputTd = document.createElement("td");
                    const input = document.createElement("input");
                    input.classList.add("tapeInput");
                    input.type = "text";
                    input.id = `input_${tapeName}`;
                    input.name = `input_${tapeName}`;
                    inputTd.appendChild(input);
                    tr.appendChild(inputTd);
                    controlTable.append(tr);
                }
            }
            
            function reloadResults() {

                var symbolName = document.getElementById("selectSymbol").value;

                var results = [];
                var tries = 0;

                CURRENT_INPUTS = {};
                for (const [tapeName, color] of CURRENT_TAPES) {
                    const input = document.getElementById(`input_${tapeName}`);
                    const value = input.value.trim();
                    if (value.length == 0) {
                        continue;
                    }
                    CURRENT_INPUTS[tapeName] = value;
                }

                while (results.length < 5 && tries < 1000) {
                    const result = project.parse(symbolName, CURRENT_INPUTS, 1, true);
                    results = results.concat(result);
                    tries++;
                }
                
                var resultsTable  = document.getElementById("resultsTable"); 
                resultsTable.innerHTML = "";
                for (var i = 0; i < results.length; i++) {
                    displayRecord(results[i], resultsTable);
                }
            }

            function displayRecord(record, table) {

                
                for (const [key, color] of CURRENT_TAPES) {

                    if (!record.hasOwnProperty(key)) {
                        continue;
                    }

                    var tr = table.insertRow();
                    tr.classList.add("resultsTr");
                    tr.style.backgroundColor = color;
                    
                    var keyCell = tr.insertCell();
                    keyCell.classList.add("resultsKey");
                    keyCell.appendChild(document.createTextNode(key));

                    var valueCell = tr.insertCell();
                    valueCell.classList.add("resultsValue");
                    valueCell.appendChild(document.createTextNode(record[key]));
                }

                var blankRow = table.insertRow();
                blankRow.classList.add("resultsBlankTr");
                var blankCell = blankRow.insertCell();
                blankCell = blankRow.insertCell();
                blankCell.appendChild(document.createTextNode("\u00A0"));
                blankCell.classList.add("resultsBlank");
            }

            window.onload = async function() {
                
                try {
                    await reloadGrammar();

                    var button = document.getElementById("reloadButton");
                    button.onclick = async function(ev) {
                        await reloadGrammar();
                    }

                    var selector = document.getElementById("selectSymbol");
                    selector.onchange = function(ev) {
                        removeElementsByClass("tapeInputTr");
                        reloadInputs();
                    };
                    

                    document.getElementById("sampleButton").onclick = async function(ev) {
                        await reloadResults();
                    }

                } catch(err) {
                    alert(err);
                }

            };

            
            function resultsToCSV(labels, items) {
                const replacer = (key, value) => value === null ? '' : value // specify how you want to handle null values here
                return [
                    labels.join(','), // header row first
                    ...items.map(row => labels.map(label => JSON.stringify(row[label], replacer)).join(','))
                ].join('\r\n');
            }

            function downloadResults() {

                // determine what symbol to generate from
                const symbolSelect = document.getElementById("selectSymbol"); 
                const symbolName = symbolSelect.value;

                // determine what tape names are relevant to this symbol
                const tapeInfo = project.getTapeNames(symbolName);
                const tapeNames = tapeInfo.map(([k, v]) => k);

                // generate the results
                const results = project.generate(symbolName);

                // determine what format to output in
                var formatSelect = document.getElementById("downloadFormatSelect");
                const downloadFormat = formatSelect.value;

                var filename, text;
                // convert the results to the appropriate format
                if (downloadFormat == "json") {
                    filename = `${symbolName}.json`;
                    text = JSON.stringify(results, null, 2);
                } else if (downloadFormat == "csv") {
                    filename = `${symbolName}.csv`;
                    text = resultsToCSV(tapeNames, results);
                }

                // create a temporary link element to download from
                var element = document.createElement('a');
                element.setAttribute('href', 'data:application/json;charset=utf-8,' + encodeURIComponent(text));
                element.setAttribute('download', filename);
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
                return false;
            }

        </script>

        <table id="controlTable">
            <!-- <td colspan="2"><button id="highlightButton">Highlight</button></td></tr>-->
            <tr><td colspan="2"><button id="reloadButton">Sync and validate</button></td></tr>
            <tr id="errorTr"><td colspan="2" id="errorArea"> </td></tr>
            <tr id="selectTr"><td>Input:</td><td class="wideTd"><select id="selectSymbol"> </select></td></tr>
        </table>

        <table id="sampleTable">
            <tr><td><button class="downloadButton" onclick="downloadResults()">Download results</button>
                </td>
                <td>
                    <select id="downloadFormatSelect">
                        <option value="csv">CSV</option>
                        <option value="json">JSON</option>
                    </select>
                </td>
            </tr>
            <tr><td colspan="2"><button id="sampleButton">Sample</button></td></tr>
        </table>

        <p id="loadingP">Loading...</p>

        <table id="resultsTable"> </table>


    </body>
</html>